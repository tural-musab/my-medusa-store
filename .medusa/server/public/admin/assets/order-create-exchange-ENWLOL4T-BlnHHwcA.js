import{I as ve}from"./chunk-QJ6SBVJ2-CYF6weoD.js";import{R as He,O as Fe,C as Le}from"./chunk-P3DRE4IY-CGoWvnN_.js";import{M as ye}from"./chunk-NNBHHXXN-DYV0uoJd.js";import{c as ze,d as Be,e as Ve,u as Ue,f as Ge,g as $e,h as Qe,i as Xe,j as Je,k as Ke,l as We,m as Ze,n as Ye,o as et,p as tt,q as st}from"./chunk-DCN4IKDA-D23n9ug1.js";import{g as Ie}from"./chunk-PXZ7QYKX-DZ_CHK12.js";import{c as nt,o as it}from"./chunk-A35MFVT3-CiSRVBBr.js";import{D as at}from"./chunk-7I5DQGWY-CwOWioty.js";import{a as K}from"./chunk-PDWBYQOW-Dmlh1vBq.js";import{P as Ne,a as Se}from"./chunk-IQBAUTU5-DkoCfGtX.js";import{R as ot,u as rt,b as V,aS as lt,aT as dt,r as v,j as e,t as D,a8 as ct,H as ce,y as ee,v as g,aa as ut,B as W,ab as mt,cQ as pt,w as Ee,T as G,s as Ce,cU as ht,aB as Pe,I as de,A as Me,X as me,cV as ft,ac as q}from"./index-DMWyorzQ.js";import{u as ke,_ as Ae}from"./chunk-B2JT2FOA-BKakyhYn.js";import"./lodash-ih1iBsCU.js";import{C as te}from"./chunk-GZBFGV7Y-DdTQM-yw.js";import{c as pe}from"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-GJUPECDU-p4suM_Sf.js";import{u as we}from"./chunk-C76H5USB-D6UMInaR.js";import{K as xt}from"./chunk-6HTZNHPT-DF8qBEF8.js";import{R as Q,u as gt,a as De,S as U}from"./chunk-4TC5YS65-BL_dGImE.js";import{u as Te}from"./chunk-GRT22PE5-DbAZicie.js";import{u as _t}from"./use-prompt-1XhG1-Oe.js";import{P as he}from"./pencil-square-CJ-bXGUy.js";import{D as bt}from"./document-text-GsGpJtbb.js";import{X as Re}from"./x-circle-DTKEf63-.js";import{C as fe}from"./currency-input-B8XHwif4.js";import{A as qe}from"./alert-BYShsL77.js";import{c as Oe}from"./index-CWnEHY0n.js";import{C as se}from"./checkbox-Bjek-VQs.js";import"./Trans-nzFNXaa5.js";import"./chunk-P3UUX2T6-DVlBMYC5.js";import"./chunk-YEDAFXMB-CxPBg1Cz.js";import"./chunk-AOFGTNG6-Dtjxy5pV.js";import"./table-fXxTwIFm.js";import"./chunk-EMIHDNB7-CgkF3HUC.js";import"./plus-mini-ClLv5vKz.js";import"./command-bar-CcRfqRVM.js";import"./index-BkDd4bqD.js";import"./x-mark-mini-no8ejXJD.js";import"./triangles-mini-HK0Pg-7V.js";import"./chunk-PFKKVLZX-CpC8BTlr.js";import"./format-QmTXQ6pE.js";import"./_isIndex-DoiKt3np.js";import"./index-B0s-AoNe.js";import"./date-picker-BqY4iz6e.js";import"./popover-kGNFYvK-.js";import"./triangle-left-mini-DmNDZFw-.js";import"./prompt-CwIhjJI7.js";import"./index.esm-D8n8FXZl.js";var jt=q.object({inbound_items:q.array(q.object({item_id:q.string(),quantity:q.number(),reason_id:q.string().nullish(),note:q.string().nullish()})),outbound_items:q.array(q.object({item_id:q.string(),quantity:q.number()})),location_id:q.string().optional(),inbound_option_id:q.string().nullish(),outbound_option_id:q.string().nullish(),send_notification:q.boolean().optional()}),J=Oe(),vt=n=>{const{t:l}=V();return v.useMemo(()=>[J.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:r=>o.toggleAllPageRowsSelected(!!r)}),cell:({row:o})=>{const r=o.getCanSelect();return e.jsx(se,{disabled:!r,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),J.display({id:"product",header:()=>e.jsx(Se,{}),cell:({row:o})=>e.jsx(Ne,{product:{thumbnail:o.original.thumbnail,title:o.original.product_title}})}),J.accessor("variant.sku",{header:l("fields.sku"),cell:({getValue:o})=>o()||"-"}),J.accessor("variant.title",{header:l("fields.variant")}),J.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.quantity")})}),cell:({getValue:o,row:r})=>Ie(r.original)}),J.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:l("fields.price")})}),cell:({getValue:o})=>{const r=o()||0,a=K(r,n);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:a})})}})],[l,n])},yt=()=>{const{t:n}=V();return[{key:"created_at",label:n("fields.createdAt"),type:"date"},{key:"updated_at",label:n("fields.updatedAt"),type:"date"}]},It=({pageSize:n=50,prefix:l})=>{const o=we(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:p,...x}=o;return{searchParams:{...x,limit:n,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:p?JSON.parse(p):void 0},raw:o}},ne=50,xe="rit",Nt=({onSelectionChange:n,selectedItems:l,items:o,currencyCode:r})=>{const{t:a}=V(),[p,x]=v.useState(l.reduce((b,j)=>(b[j]=!0,b),{})),N=b=>{const j=typeof b=="function"?b(p):b;x(j),n(Object.keys(j))},{searchParams:y,raw:S}=It({pageSize:ne,prefix:xe}),P=v.useMemo(()=>{const{order:b,offset:j,limit:O,q:E,created_at:H,updated_at:$}=y;let R=o;if(E&&(R=R.filter(F=>{var C;return F.product_title.toLowerCase().includes(E.toLowerCase())||F.variant_title.toLowerCase().includes(E.toLowerCase())||((C=F.variant_sku)==null?void 0:C.toLowerCase().includes(E.toLowerCase()))})),b){const F=b[0]==="-"?"desc":"asc",C=b.replace("-","");R=St(R,C,F)}return H&&(R=ge(R,H,"created_at")),$&&(R=ge(R,$,"updated_at")),R.slice(j,j+O)},[o,r,y]),A=vt(r),T=yt(),{table:w}=ke({data:P,columns:A,count:P.length,enablePagination:!0,getRowId:b=>b.id,pageSize:ne,enableRowSelection:b=>Ie(b.original)>0,rowSelection:{state:p,updater:N}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:w,columns:A,pageSize:ne,count:P.length,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:a("fields.product")},{key:"variant_title",label:a("fields.variant")},{key:"sku",label:a("fields.sku")}],prefix:xe,queryObject:S})})},St=(n,l,o)=>n.sort((r,a)=>{let p,x;return l==="product_title"?(p=r.product_title,x=a.product_title):l==="variant_title"?(p=r.variant_title,x=a.variant_title):l==="sku"&&(p=r.variant_sku,x=a.variant_sku),p<x?o==="asc"?-1:1:p>x?o==="asc"?1:-1:0}),ge=(n,l,o)=>{const{gt:r,gte:a,lt:p,lte:x}=l;return n.filter(N=>{const y=new Date(N[o]);let S=!0;return r&&(S=S&&y>new Date(r)),a&&(S=S&&y>=new Date(a)),p&&(S=S&&y<new Date(p)),x&&(S=S&&y<=new Date(x)),S})};function Et({item:n,previewItem:l,currencyCode:o,form:r,onRemove:a,onUpdate:p,index:x}){const{t:N}=V(),{return_reasons:y=[]}=ht({fields:"+label"}),S=r.watch(`inbound_items.${x}`),P=typeof S.reason_id=="string",A=typeof S.note=="string";return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Pe,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),n.variant_sku&&e.jsxs("span",{children:["(",n.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:n.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(g.Field,{control:r.control,name:`inbound_items.${x}.quantity`,render:({field:T})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(de,{...T,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:n.quantity,type:"number",onBlur:w=>{const b=w.target.value,j=b===""?null:Number(b);T.onChange(j),j&&p({quantity:j})}})}),e.jsx(g.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:N("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:o,amount:l.return_requested_total})}),e.jsx(Me,{groups:[{actions:[!P&&{label:N("actions.addReason"),onClick:()=>r.setValue(`inbound_items.${x}.reason_id`,""),icon:e.jsx(Le,{})},!A&&{label:N("actions.addNote"),onClick:()=>r.setValue(`inbound_items.${x}.note`,""),icon:e.jsx(bt,{})},{label:N("actions.remove"),onClick:a,icon:e.jsx(Re,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[P&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:N("orders.returns.reason")}),e.jsx(g.Hint,{className:"!mt-1",children:N("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(g.Field,{control:r.control,name:`inbound_items.${x}.reason_id`,render:({field:{ref:T,value:w,onChange:b,...j}})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(te,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:w,onChange:O=>{p({reason_id:O}),b(O)},...j,options:y.map(O=>({label:O.label,value:O.id}))})}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx(ee,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{r.setValue(`inbound_items.${x}.reason_id`,null),p({reason_id:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]}),A&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:N("orders.returns.note")}),e.jsx(g.Hint,{className:"!mt-1",children:N("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(g.Field,{control:r.control,name:`inbound_items.${x}.note`,render:({field:{ref:T,...w}})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(de,{...w,onBlur:()=>{w.onChange(w.value),p({internal_note:w.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx(ee,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{r.setValue(`inbound_items.${x}.note`,null),p({internal_note:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]})]})]})}var ie=[],_e=[],Ct=({order:n,preview:l,exchange:o,form:r,orderReturn:a})=>{var k;const{t:p}=V(),{setIsOpen:x}=De(),[N,y]=v.useState({}),{mutateAsync:S}=it((k=l==null?void 0:l.order_change)==null?void 0:k.return_id,n.id),{mutateAsync:P}=Qe(o.id,n.id),{mutateAsync:A}=Xe(o.id,n.id),{mutateAsync:T}=Je(o.id,n.id),{mutateAsync:w}=Ke(o.id,n.id),{mutateAsync:b}=We(o.id,n.id),j=v.useMemo(()=>{var d;return(d=l==null?void 0:l.items)==null?void 0:d.filter(t=>{var i;return!!((i=t.actions)!=null&&i.find(s=>s.exchange_id===o.id))})},[l.items]),O=j.filter(d=>{var t;return!!((t=d.actions)!=null&&t.find(i=>i.action==="RETURN_ITEM"))}),E=v.useMemo(()=>{var d;return new Map((d=n==null?void 0:n.items)==null?void 0:d.map(t=>[t.id,t]))},[n.items]),H=r.watch("location_id"),{stock_locations:$=[]}=pt({limit:999}),{shipping_options:R=[]}=Te({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:H},{enabled:!!H}),F=R.filter(d=>!!d.rules.find(t=>t.attribute==="is_return"&&t.value==="true")),{fields:C,append:X,remove:L,update:z}=Ee({name:"inbound_items",control:r.control}),B=v.useMemo(()=>new Map(j.map(d=>[d.id,d])),[j,C]);v.useEffect(()=>{const d={};O.forEach(t=>{var s,c;const i=C.findIndex(f=>f.item_id===t.id);if(d[t.id]=!0,i>-1){if(C[i].quantity!==t.detail.return_requested_quantity){const f=(s=t.actions)==null?void 0:s.find(M=>M.action==="RETURN_ITEM");z(i,{...C[i],quantity:t.detail.return_requested_quantity,note:f==null?void 0:f.internal_note,reason_id:(c=f==null?void 0:f.details)==null?void 0:c.reason_id})}}else X({item_id:t.id,quantity:t.detail.return_requested_quantity},{shouldFocus:!1})}),C.forEach((t,i)=>{t.item_id in d||L(i)})},[j]),v.useEffect(()=>{const d=l.shipping_methods.find(t=>{var i;return(i=t.actions)==null?void 0:i.find(s=>s.action==="SHIPPING_ADD"&&!!s.return_id)});d?r.setValue("inbound_option_id",d.shipping_option_id):r.setValue("inbound_option_id","")},[l.shipping_methods]),v.useEffect(()=>{r.setValue("location_id",a==null?void 0:a.location_id)},[a]);const h=!C.length,m=async()=>{var d,t,i;ie.length&&await T({items:ie.map(s=>({id:s,quantity:1}))},{onError:s=>{D.error(s.message)}});for(const s of _e){const c=(i=(t=(d=j.find(f=>f.id===s))==null?void 0:d.actions)==null?void 0:t.find(f=>f.action==="RETURN_ITEM"))==null?void 0:i.id;c&&await b(c,{onError:f=>{D.error(f.message)}})}x("inbound-items",!1)},u=async d=>{await S({location_id:d})},_=async d=>{const i=l.shipping_methods.filter(s=>{var c;return(c=s.actions)==null?void 0:c.find(f=>f.action==="SHIPPING_ADD"&&!!f.return_id)}).filter(Boolean).map(s=>{var f;const c=(f=s.actions)==null?void 0:f.find(M=>M.action==="SHIPPING_ADD"&&!!M.return_id);if(c)return A(c.id)});await Promise.all(i),d&&await P({shipping_option_id:d},{onError:s=>{D.error(s.message)}})},I=v.useMemo(()=>H?!C.map(t=>{var s,c;const i=E.get(t.item_id);return!(i!=null&&i.variant_id)||!(i!=null&&i.variant)||!((s=i.variant)!=null&&s.manage_inventory)?!0:(c=N[i.variant_id])==null?void 0:c.find(f=>f.location_id===H)}).every(Boolean):!1,[C,N,H]);return v.useEffect(()=>{(async()=>{const t={};if(!C.length)return t;const i=C.map(c=>c==null?void 0:c.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:i,fields:"*inventory.location_levels"})).variants.forEach(c=>{var f,M;t[c.id]=((M=(f=c.inventory)==null?void 0:f[0])==null?void 0:M.location_levels)||[]}),t})().then(t=>{y(t)})},[C]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ce,{level:"h2",children:p("orders.returns.inbound")}),e.jsxs(U,{id:"inbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:p("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(Nt,{items:n.items,selectedItems:C.map(d=>d.item_id),currencyCode:n.currency_code,onSelectionChange:d=>{const t=C.map(i=>i.item_id);ie=d.filter(i=>!t.includes(i)),_e=t.filter(i=>!d.includes(i))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(Q.Close,{asChild:!0,children:e.jsx(W,{type:"button",variant:"secondary",size:"small",children:p("actions.cancel")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await m(),children:p("actions.save")},"submit-button")]})})})]})]})]}),h&&e.jsx(ve,{}),C.map((d,t)=>B.get(d.item_id)&&E.get(d.item_id)&&e.jsx(Et,{item:E.get(d.item_id),previewItem:B.get(d.item_id),currencyCode:n.currency_code,form:r,onRemove:()=>{var s,c,f;const i=(f=(c=(s=j.find(M=>M.id===d.item_id))==null?void 0:s.actions)==null?void 0:c.find(M=>M.action==="RETURN_ITEM"))==null?void 0:f.id;i&&b(i,{onError:M=>{D.error(M.message)}})},onUpdate:i=>{var c,f;const s=(f=(c=j.find(M=>M.id===d.item_id))==null?void 0:c.actions)==null?void 0:f.find(M=>M.action==="RETURN_ITEM");s&&w({...i,actionId:s.id},{onError:M=>{var Z,ue;(Z=s.details)!=null&&Z.quantity&&i.quantity&&r.setValue(`inbound_items.${t}.quantity`,(ue=s.details)==null?void 0:ue.quantity),D.error(M.message)}})},index:t},d.id)),!h&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:p("orders.returns.location")}),e.jsx(g.Hint,{className:"!mt-1",children:p("orders.returns.locationHint")})]}),e.jsx(g.Field,{control:r.control,name:"location_id",render:({field:{value:d,onChange:t,...i}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(te,{...i,value:d??void 0,onChange:s=>{t(s),u(s)},options:($??[]).map(s=>({label:s.name,value:s.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(g.Label,{children:[p("orders.returns.inboundShipping"),e.jsxs(G,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",p("fields.optional"),")"]})]}),e.jsx(g.Hint,{className:"!mt-1",children:p("orders.returns.inboundShippingHint")})]}),e.jsx(g.Field,{control:r.control,name:"inbound_option_id",render:({field:{value:d,onChange:t,...i}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(te,{allowClear:!0,value:d??void 0,onChange:s=>{t(s),_(s)},...i,options:F.map(s=>({label:s.name,value:s.id})),disabled:!H,noResultsPlaceholder:e.jsx(He,{})})})})})]})]}),I&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:p("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:p("orders.returns.noInventoryLevelDesc")})]})]})},Y=Oe(),Pt=n=>{const{t:l}=V();return v.useMemo(()=>[Y.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:r=>o.toggleAllPageRowsSelected(!!r)}),cell:({row:o})=>{const r=o.getCanSelect();return e.jsx(se,{disabled:!r,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),Y.display({id:"product",header:()=>e.jsx(Se,{}),cell:({row:o})=>e.jsx(Ne,{product:o.original.product})}),Y.accessor("sku",{header:l("fields.sku"),cell:({getValue:o})=>o()||"-"}),Y.accessor("title",{header:l("fields.title")})],[l,n])},Mt=()=>{const{t:n}=V();return[{key:"created_at",label:n("fields.createdAt"),type:"date"},{key:"updated_at",label:n("fields.updatedAt"),type:"date"}]},kt=({pageSize:n=50,prefix:l})=>{const o=we(["q","offset","order","created_at","updated_at"],l),{offset:r,created_at:a,updated_at:p,...x}=o;return{searchParams:{...x,limit:n,offset:r?Number(r):0,created_at:a?JSON.parse(a):void 0,updated_at:p?JSON.parse(p):void 0},raw:o}},ae=50,be="rit",At=({onSelectionChange:n,selectedItems:l,currencyCode:o})=>{const{t:r}=V(),[a,p]=v.useState(l.reduce((b,j)=>(b[j]=!0,b),{})),x=b=>{const j=typeof b=="function"?b(a):b;p(j),n(Object.keys(j))},{searchParams:N,raw:y}=kt({pageSize:ae,prefix:be}),{variants:S=[],count:P}=ft({...N,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),A=Pt(o),T=Mt(),{table:w}=ke({data:S,columns:A,count:P,enablePagination:!0,getRowId:b=>b.id,pageSize:ae,enableRowSelection:b=>!0,rowSelection:{state:a,updater:x}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:w,columns:A,pageSize:ae,count:P,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:r("fields.product")},{key:"title",label:r("fields.title")},{key:"sku",label:r("fields.sku")}],prefix:be,queryObject:y})})};function wt({previewItem:n,currencyCode:l,form:o,onRemove:r,onUpdate:a,index:p}){const{t:x}=V();return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Pe,{src:n.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[n.title," "]}),n.variant_sku&&e.jsxs("span",{children:["(",n.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:n.subtitle})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(g.Field,{control:o.control,name:`outbound_items.${p}.quantity`,render:({field:N})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(de,{...N,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:y=>{const S=y.target.value,P=S===""?null:Number(S);N.onChange(P),P&&a({quantity:P})}})}),e.jsx(g.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:x("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:l,amount:n.total})}),e.jsx(Me,{groups:[{actions:[{label:x("actions.remove"),onClick:r,icon:e.jsx(Re,{})}].filter(Boolean)}]})]})]})})}var oe=[],je=[],Dt=({order:n,preview:l,exchange:o,form:r})=>{const{t:a}=V(),{setIsOpen:p}=De(),[x,N]=v.useState({}),{shipping_options:y=[]}=Te({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id"}),S=y.filter(h=>!!h.rules.find(m=>m.attribute==="is_return"&&m.value==="false")),{mutateAsync:P}=Ze(o.id,n.id),{mutateAsync:A}=Ye(o.id,n.id),{mutateAsync:T}=et(o.id,n.id),{mutateAsync:w}=tt(o.id,n.id),{mutateAsync:b}=st(o.id,n.id),j=v.useMemo(()=>{var h;return(h=l==null?void 0:l.items)==null?void 0:h.filter(m=>{var u;return!!((u=m.actions)!=null&&u.find(_=>_.exchange_id===o.id&&_.action==="ITEM_ADD"))})},[l.items]),O=v.useMemo(()=>{var h;return new Map((h=n==null?void 0:n.items)==null?void 0:h.map(m=>[m.variant_id,m]))},[n.items]),{fields:E,append:H,remove:$,update:R}=Ee({name:"outbound_items",control:r.control}),F=v.useMemo(()=>new Map(j.map(h=>[h.variant_id,h])),[j,E]);v.useEffect(()=>{const h={};j.forEach(m=>{const u=E.findIndex(_=>_.item_id===m.id);h[m.id]=!0,u>-1?E[u].quantity!==m.detail.quantity&&R(u,{...E[u],quantity:m.detail.quantity}):H({item_id:m.id,quantity:m.detail.quantity,variant_id:m.variant_id},{shouldFocus:!1})}),E.forEach((m,u)=>{m.item_id in h||$(u)})},[j]);const C=r.watch("location_id"),X=!E.length,L=async()=>{var h,m;oe.length&&await T({items:oe.map(u=>({variant_id:u,quantity:1}))},{onError:u=>{D.error(u.message)}});for(const u of je){const _=(m=(h=j.find(I=>I.variant_id===u))==null?void 0:h.actions)==null?void 0:m.find(I=>I.action==="ITEM_ADD");_!=null&&_.id&&await b(_==null?void 0:_.id,{onError:I=>{D.error(I.message)}})}p("outbound-items",!1)};v.useEffect(()=>{const h=l.shipping_methods.find(m=>{var u;return!!((u=m.actions)!=null&&u.find(_=>_.action==="SHIPPING_ADD"&&!_.return_id))});h?r.setValue("outbound_option_id",h.shipping_option_id):r.setValue("outbound_option_id","")},[l.shipping_methods]);const z=async h=>{const u=l.shipping_methods.filter(_=>{var I;return!!((I=_.actions)!=null&&I.find(k=>k.action==="SHIPPING_ADD"&&!k.return_id))}).filter(Boolean).map(_=>{var k;const I=(k=_.actions)==null?void 0:k.find(d=>d.action==="SHIPPING_ADD"&&!d.return_id);if(I)return A(I.id)});await Promise.all(u),h&&await P({shipping_option_id:h},{onError:_=>{D.error(_.message)}})},B=v.useMemo(()=>C?!E.map(m=>{var _,I;const u=O.get(m.variant_id);return!(u!=null&&u.variant_id)||!(u!=null&&u.variant)||!((_=u.variant)!=null&&_.manage_inventory)?!0:(I=x[u.variant_id])==null?void 0:I.find(k=>k.location_id===C)}).every(Boolean):!1,[E,x,C]);return v.useEffect(()=>{(async()=>{const m={};if(!E.length)return m;const u=E.map(I=>I==null?void 0:I.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:u,fields:"*inventory.location_levels"})).variants.forEach(I=>{var k,d;m[I.id]=((d=(k=I.inventory)==null?void 0:k[0])==null?void 0:d.location_levels)||[]}),m})().then(m=>{N(m)})},[E]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ce,{level:"h2",children:a("orders.returns.outbound")}),e.jsxs(U,{id:"outbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:a("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(At,{selectedItems:E.map(h=>h.variant_id),currencyCode:n.currency_code,onSelectionChange:h=>{const m=E.map(u=>u.variant_id);oe=h.filter(u=>!m.includes(u)),je=m.filter(u=>!h.includes(u))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(Q.Close,{asChild:!0,children:e.jsx(W,{type:"button",variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await L(),children:a("actions.save")},"submit-button")]})})})]})]})]}),X&&e.jsx(ve,{}),E.map((h,m)=>F.get(h.variant_id)&&e.jsx(wt,{previewItem:F.get(h.variant_id),currencyCode:n.currency_code,form:r,onRemove:()=>{var _,I,k;const u=(k=(I=(_=j.find(d=>d.id===h.item_id))==null?void 0:_.actions)==null?void 0:I.find(d=>d.action==="ITEM_ADD"))==null?void 0:k.id;u&&b(u,{onError:d=>{D.error(d.message)}})},onUpdate:u=>{var I,k,d;const _=(d=(k=(I=j.find(t=>t.id===h.item_id))==null?void 0:I.actions)==null?void 0:k.find(t=>t.action==="ITEM_ADD"))==null?void 0:d.id;_&&w({...u,actionId:_},{onError:t=>{D.error(t.message)}})},index:m},h.id)),!X&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:a("orders.exchanges.outboundShipping")}),e.jsx(g.Hint,{className:"!mt-1",children:a("orders.exchanges.outboundShippingHint")})]}),e.jsx(g.Field,{control:r.control,name:"outbound_option_id",render:({field:{value:h,onChange:m,...u}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(te,{allowClear:!0,noResultsPlaceholder:e.jsx(Fe,{}),value:h??void 0,onChange:_=>{m(_),z(_)},...u,options:S.map(_=>({label:_.name,value:_.id})),disabled:!S.length})})})})]})}),B&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:a("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:a("orders.returns.noInventoryLevelDesc")})]})]})},re=!1,Tt=({order:n,preview:l,exchange:o,orderReturn:r})=>{const{t:a}=V(),{handleSuccess:p}=gt(),[x,N]=v.useState(!1),[y,S]=v.useState(!1),[P,A]=v.useState(0),[T,w]=v.useState(0),{mutateAsync:b,isPending:j}=Ve(o.id,n.id),{mutateAsync:O,isPending:E}=Ue(o.id,n.id),{mutateAsync:H,isPending:$}=Ge(o.id,n.id),{mutateAsync:R,isPending:F}=$e(o.id,n.id),C=j||E||F||$,X=v.useMemo(()=>{var t;return(t=l==null?void 0:l.items)==null?void 0:t.filter(i=>{var s;return!!((s=i.actions)!=null&&s.find(c=>c.exchange_id===o.id))})},[l.items]),L=X.filter(t=>{var i;return!!((i=t.actions)!=null&&i.find(s=>s.action==="RETURN_ITEM"))}),z=X.filter(t=>{var i;return!!((i=t.actions)!=null&&i.find(s=>s.action==="ITEM_ADD"))}),B=ct({defaultValues:()=>{const t=l.shipping_methods.find(s=>{var c;return!!((c=s.actions)!=null&&c.find(f=>f.action==="SHIPPING_ADD"&&!!f.return_id))}),i=l.shipping_methods.find(s=>{var c;return!!((c=s.actions)!=null&&c.find(f=>f.action==="SHIPPING_ADD"&&!f.return_id))});return Promise.resolve({inbound_items:L.map(s=>{var f,M;const c=(f=s.actions)==null?void 0:f.find(Z=>Z.action==="RETURN_ITEM");return{item_id:s.id,variant_id:s.variant_id,quantity:s.detail.return_requested_quantity,note:c==null?void 0:c.internal_note,reason_id:(M=c==null?void 0:c.details)==null?void 0:M.reason_id}}),outbound_items:z.map(s=>({item_id:s.id,variant_id:s.variant_id,quantity:s.detail.quantity})),inbound_option_id:t?t.shipping_option_id:"",outbound_option_id:i?i.shipping_option_id:"",location_id:r==null?void 0:r.location_id,send_notification:!1})},resolver:mt(jt)}),h=l.shipping_methods.find(t=>{var i;return!!((i=t.actions)!=null&&i.find(s=>s.action==="SHIPPING_ADD"&&!!s.return_id))}),m=l.shipping_methods.find(t=>{var i;return!!((i=t.actions)!=null&&i.find(s=>s.action==="SHIPPING_ADD"&&!s.return_id))});v.useEffect(()=>{h&&A(h.total)},[h]),v.useEffect(()=>{m&&w(m.total)},[m]);const u=B.watch("inbound_option_id"),_=B.watch("outbound_option_id"),I=_t(),k=B.handleSubmit(async t=>{try{if(!await I({title:a("general.areYouSure"),description:a("orders.exchanges.confirmText"),confirmText:a("actions.continue"),cancelText:a("actions.cancel"),variant:"confirmation"}))return;await b({no_notification:!t.send_notification}),p()}catch(i){D.error(a("general.error"),{description:i.message})}});v.useEffect(()=>{var t;x&&((t=document.getElementById("js-inbound-shipping-input"))==null||t.focus())},[x]),v.useEffect(()=>{var t;y&&((t=document.getElementById("js-outbound-shipping-input"))==null||t.focus())},[y]),v.useEffect(()=>()=>{re&&(O(void 0,{onSuccess:()=>{D.success(a("orders.exchanges.actions.cancelExchange.successToast"))},onError:t=>{D.error(t.message)}}),re=!1)},[]);const d=v.useMemo(()=>{const t=l.shipping_methods.find(i=>{var s;return!!((s=i.actions)!=null&&s.find(c=>c.action==="SHIPPING_ADD"&&!!c.return_id))});return(t==null?void 0:t.total)||0},[l.shipping_methods]);return e.jsx(Q.Form,{form:B,children:e.jsxs(xt,{onSubmit:k,className:"flex h-full flex-col",children:[e.jsx(Q.Header,{}),e.jsx(Q.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(ce,{level:"h1",children:a("orders.exchanges.create")}),e.jsx(Ct,{form:B,preview:l,order:n,exchange:o,orderReturn:r}),e.jsx(Dt,{form:B,preview:l,order:n,exchange:o}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(L.reduce((t,i)=>{var c;const s=(c=i.actions)==null?void 0:c.find(f=>f.action==="RETURN_ITEM");return t=t+((s==null?void 0:s.amount)||0),t},0)*-1,n.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(z.reduce((t,i)=>{var c;const s=(c=i.actions)==null?void 0:c.find(f=>f.action==="ITEM_ADD");return t=t+((s==null?void 0:s.amount)||0),t},0),n.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!x&&e.jsx(ee,{onClick:()=>N(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(L!=null&&L.length)||!u,children:e.jsx(he,{})}),x?e.jsx(fe,{id:"js-inbound-shipping-input",onBlur:()=>{let t;l.shipping_methods.forEach(s=>{if(s.actions)for(const c of s.actions)c.action==="SHIPPING_ADD"&&c.return_id&&(t=c.id)});const i=P===""?null:parseFloat(P);t&&H({actionId:t,custom_amount:i},{onError:s=>{D.error(s.message)}}),N(!1)},symbol:pe[n.currency_code.toUpperCase()].symbol_native,code:n.currency_code,onValueChange:A,value:P,disabled:!(L!=null&&L.length)}):K(d,n.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!y&&e.jsx(ee,{onClick:()=>S(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(z!=null&&z.length)||!_,children:e.jsx(he,{})}),y?e.jsx(fe,{id:"js-outbound-shipping-input",onBlur:()=>{let t;l.shipping_methods.forEach(s=>{if(s.actions)for(const c of s.actions)c.action==="SHIPPING_ADD"&&!c.return_id&&(t=c.id)});const i=T===""?null:parseFloat(T);t&&R({actionId:t,custom_amount:i},{onError:s=>{D.error(s.message)}}),S(!1)},symbol:pe[n.currency_code.toUpperCase()].symbol_native,code:n.currency_code,onValueChange:w,value:T,disabled:!(z!=null&&z.length)}):K((m==null?void 0:m.amount)??0,n.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:a("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:K(l.summary.pending_difference,n.currency_code)})]})]}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(g.Field,{control:B.control,name:"send_notification",render:({field:{onChange:t,value:i,...s}})=>e.jsxs(g.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(g.Control,{className:"mr-4 self-start",children:e.jsx(ut,{className:"mt-[2px]",checked:!!i,onCheckedChange:t,...s})}),e.jsxs("div",{className:"block",children:[e.jsx(g.Label,{children:a("orders.returns.sendNotification")}),e.jsx(g.Hint,{className:"!mt-1",children:a("orders.returns.sendNotificationHint")})]})]}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(Q.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(Q.Close,{asChild:!0,children:e.jsx(W,{type:"button",onClick:()=>re=!0,variant:"secondary",size:"small",children:a("orders.exchanges.cancel.title")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",isLoading:C,children:a("orders.exchanges.confirm")},"submit-button")]})})})]})})},le=!1,Ps=()=>{const{id:n}=ot(),l=rt(),{t:o}=V(),{order:r}=lt(n,{fields:at}),{order:a}=dt(n),[p,x]=v.useState(),{mutateAsync:N}=ze(r.id),{exchange:y}=Be(p,void 0,{enabled:!!p}),{return:S}=nt(y==null?void 0:y.return_id,void 0,{enabled:!!(y!=null&&y.return_id)});return v.useEffect(()=>{async function P(){if(!(le||!a)){if(a.order_change){a.order_change.change_type==="exchange"?x(a.order_change.exchange_id):(l(`/orders/${a.id}`,{replace:!0}),D.error(o("orders.exchanges.activeChangeError")));return}le=!0;try{const{exchange:A}=await N({order_id:a.id});x(A.id)}catch(A){D.error(A.message),l(`/orders/${a.id}`,{replace:!0})}finally{le=!1}}}P()},[a]),e.jsx(Q,{children:y&&a&&r&&e.jsx(Tt,{order:r,exchange:y,preview:a,orderReturn:S})})};export{Ps as Component};
